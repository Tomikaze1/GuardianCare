<ion-content class="profile-content" fullscreen>
  <ion-refresher slot="fixed" (ionRefresh)="handleRefresh($event)">
    <ion-refresher-content
      pullingIcon="arrow-down-circle-outline"
      pullingText="Pull to refresh"
      refreshingSpinner="lines"
      refreshingText="Refreshing...">
    </ion-refresher-content>
  </ion-refresher>
  <div class="logo-container">
    <div class="logo-wrapper">
      <div class="custom-logo">
        <ion-icon name="shield" class="shield-icon"></ion-icon>
        <ion-icon name="person" class="person-icon"></ion-icon>
      </div>
      <div class="logo-glow"></div>
    </div>
    <div class="app-title">{{ 'PROFILE.TITLE' | translate }}</div>
    <div class="app-subtitle">{{ 'PROFILE.SUBTITLE' | translate }}</div>
    <div class="title-underline"></div>
  </div>

  <div class="profile-form">
    <form [formGroup]="profileForm" (ngSubmit)="updateProfile()">
      
      
      <!-- Profile Picture Section -->
      <div class="section-header">
        <span>{{ 'PROFILE.PROFILE_PICTURE' | translate }}</span>
        <div class="section-underline"></div>
      </div>

      <div class="profile-picture-container">
        <div class="profile-picture-wrapper" (click)="selectProfileImage()">
          <div class="profile-picture" [class.has-image]="profileImage">
            <img *ngIf="profileImage" [src]="profileImage" alt="Profile Picture" class="profile-image">
            <ion-icon *ngIf="!profileImage" name="person-circle" class="default-avatar"></ion-icon>
          </div>
          <div class="edit-overlay">
            <ion-icon name="camera" class="edit-icon"></ion-icon>
            <span class="edit-text">{{ 'PROFILE.CHANGE_PHOTO' | translate }}</span>
          </div>
        </div>
      </div>

      <!-- Personal Information Section -->
      <div class="section-header">
        <span>{{ 'PROFILE.PERSONAL_INFO' | translate }}</span>
        <div class="section-underline"></div>
      </div>

      <div class="form-row">
        <div class="input-box">
          <ion-icon name="person-outline"></ion-icon>
          <ion-input
            formControlName="displayName"
            placeholder="{{ 'PROFILE.FULL_NAME' | translate }}"
            [readonly]="!isEditing">
          </ion-input>
        </div>
      </div>

      <div class="form-row">
        <div class="input-box">
          <ion-icon name="call-outline"></ion-icon>
          <ion-input
            formControlName="phone"
            placeholder="{{ 'PROFILE.PHONE_NUMBER' | translate }}"
            type="tel"
            [readonly]="!isEditing">
          </ion-input>
        </div>
      </div>

      <div class="form-row">
        <div class="input-box">
          <ion-icon name="mail-outline"></ion-icon>
          <ion-input
            formControlName="email"
            placeholder="{{ 'PROFILE.EMAIL' | translate }}"
            type="email"
            readonly>
          </ion-input>
        </div>
      </div>

      <!-- Emergency Contacts Section -->
      <div class="section-header">
        <span>{{ 'PROFILE.EMERGENCY_CONTACTS' | translate }}</span>
        <div class="section-underline"></div>
      </div>

      <div class="form-row">
        <div class="emergency-contacts-container">
          <div class="contacts-header">
            <span class="contacts-title">{{ 'PROFILE.MANAGE_CONTACTS' | translate }}</span>
            <ion-button 
              fill="clear" 
              size="small" 
              (click)="addEmergencyContact()"
              class="add-contact-btn">
              <ion-icon name="add" slot="start"></ion-icon>
              {{ 'PROFILE.ADD_CONTACT' | translate }}
            </ion-button>
          </div>

          <div class="contacts-list" *ngIf="emergencyContacts.length > 0">
            <div class="contact-item" *ngFor="let contact of emergencyContacts">
              <div class="contact-info">
                <div class="contact-avatar">
                  <ion-icon name="person-circle" class="contact-icon"></ion-icon>
                </div>
                <div class="contact-details">
                  <div class="contact-name">{{ contact.name }}</div>
                  <div class="contact-phone">{{ contact.phone }}</div>
                  <div class="contact-relationship">{{ contact.relationship }}</div>
                </div>
              </div>
              <div class="contact-actions">
                <ion-button 
                  fill="clear" 
                  size="small" 
                  (click)="editEmergencyContact(contact)"
                  class="edit-btn">
                  <ion-icon name="create-outline"></ion-icon>
                </ion-button>
                <ion-button 
                  fill="clear" 
                  size="small" 
                  (click)="deleteEmergencyContact(contact)"
                  class="delete-btn">
                  <ion-icon name="trash-outline"></ion-icon>
                </ion-button>
              </div>
            </div>
          </div>

          <div class="no-contacts" *ngIf="emergencyContacts.length === 0">
            <ion-icon name="people-outline" class="no-contacts-icon"></ion-icon>
            <p class="no-contacts-text">{{ 'PROFILE.NO_EMERGENCY_CONTACTS' | translate }}</p>
            <ion-button 
              fill="outline" 
              size="small" 
              (click)="addEmergencyContact()"
              class="add-first-contact-btn">
              <ion-icon name="add" slot="start"></ion-icon>
              {{ 'PROFILE.ADD_FIRST_CONTACT' | translate }}
            </ion-button>
          </div>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="button-row">
        <ion-button 
          *ngIf="!isEditing"
          expand="block" 
          fill="outline" 
          color="medium"
          (click)="refreshProfile()"
          class="refresh-profile-btn">
          <ion-icon name="refresh-outline" slot="start"></ion-icon>
          {{ 'PROFILE.REFRESH_PROFILE' | translate }}
        </ion-button>
        
        <ion-button 
          *ngIf="!isEditing"
          expand="block" 
          fill="solid" 
          color="primary"
          (click)="toggleEdit()"
          class="edit-profile-btn">
          <ion-icon name="create-outline" slot="start"></ion-icon>
          {{ 'PROFILE.EDIT_PROFILE' | translate }}
        </ion-button>

        <ion-button 
          *ngIf="!isEditing"
          expand="block" 
          fill="solid" 
          color="danger"
          (click)="logOut()"
          class="logout-btn">
          <ion-icon name="log-out-outline" slot="start"></ion-icon>
          {{ 'PROFILE.LOGOUT' | translate }}
        </ion-button>

        <div *ngIf="isEditing" class="edit-actions">
          <ion-button 
            expand="block" 
            fill="outline" 
            color="medium"
            (click)="toggleEdit()"
            class="cancel-btn">
            <ion-icon name="close-outline" slot="start"></ion-icon>
            {{ 'PROFILE.CANCEL' | translate }}
          </ion-button>
          
          <ion-button 
            expand="block" 
            fill="solid" 
            color="primary"
            type="submit"
            [disabled]="!profileForm.valid"
            class="save-btn">
            <ion-icon name="checkmark-outline" slot="start"></ion-icon>
            {{ 'PROFILE.SAVE_CHANGES' | translate }}
          </ion-button>
        </div>
      </div>

      <!-- Settings Section -->
      <div class="section-header">
        <span>Settings</span>
        <div class="section-underline"></div>
      </div>

      <!-- Account & Security Settings -->
      <div class="form-row">
        <div class="section-header" (click)="toggleSection('account')">
          <div class="section-title-row">
            <span>Account & Security</span>
            <ion-icon name="chevron-forward-outline" class="section-toggle-icon" [class.open]="expandAccountSecurity"></ion-icon>
          </div>
          <div class="section-underline"></div>
        </div>
        
        <div class="settings-list collapsible" [class.open]="expandAccountSecurity">
          <div class="setting-item">
            <div class="setting-left">
              <div class="setting-icon">
                <ion-icon name="shield-checkmark"></ion-icon>
              </div>
              <div class="setting-title">Two-Factor Authentication</div>
            </div>
            <div class="setting-right">
              <ion-toggle [(ngModel)]="twoFactorEnabled" (ionChange)="toggleTwoFactor()"></ion-toggle>
            </div>
          </div>

          <div class="setting-item" (click)="changePassword()">
            <div class="setting-left">
              <div class="setting-icon">
                <ion-icon name="key"></ion-icon>
              </div>
              <div class="setting-title">Change Password</div>
            </div>
            <div class="setting-right">
              <ion-icon name="chevron-forward-outline" class="arrow-icon"></ion-icon>
            </div>
          </div>

          <div class="setting-item" (click)="updateEmail()">
            <div class="setting-left">
              <div class="setting-icon">
                <ion-icon name="mail"></ion-icon>
              </div>
              <div class="setting-title">Update Email</div>
            </div>
            <div class="setting-right">
              <ion-icon name="chevron-forward-outline" class="arrow-icon"></ion-icon>
            </div>
          </div>
        </div>
      </div>

      <!-- Location & Alerts Settings -->
      <div class="form-row">
        <div class="section-header" (click)="toggleSection('location')">
          <div class="section-title-row">
            <span>Location & Alerts</span>
            <ion-icon name="chevron-forward-outline" class="section-toggle-icon" [class.open]="expandLocationAlerts"></ion-icon>
          </div>
          <div class="section-underline"></div>
        </div>
        
        <div class="settings-list collapsible" [class.open]="expandLocationAlerts">
          <div class="setting-item">
            <div class="setting-left">
              <div class="setting-icon">
                <ion-icon name="location"></ion-icon>
              </div>
              <div class="setting-title">GPS Access</div>
            </div>
            <div class="setting-right">
              <ion-toggle [(ngModel)]="gpsEnabled" (ionChange)="toggleGPS()"></ion-toggle>
            </div>
          </div>

          <div class="setting-item">
            <div class="setting-left">
              <div class="setting-icon">
                <ion-icon name="time"></ion-icon>
              </div>
              <div class="setting-title">Time-based Alerts</div>
            </div>
            <div class="setting-right">
              <ion-toggle [(ngModel)]="timeBasedAlerts" (ionChange)="toggleTimeBasedAlerts()"></ion-toggle>
            </div>
          </div>

          <div class="setting-item">
            <div class="setting-left">
              <div class="setting-icon">
                <ion-icon name="warning"></ion-icon>
              </div>
              <div class="setting-title">Danger Zone Alerts</div>
            </div>
            <div class="setting-right">
              <ion-toggle [(ngModel)]="dangerZoneAlerts" (ionChange)="toggleDangerZoneAlerts()"></ion-toggle>
            </div>
          </div>
        </div>
      </div>

      <!-- Notifications Settings -->
      <div class="form-row">
        <div class="section-header" (click)="toggleSection('notifications')">
          <div class="section-title-row">
            <span>Notifications</span>
            <ion-icon name="chevron-forward-outline" class="section-toggle-icon" [class.open]="expandNotifications"></ion-icon>
          </div>
          <div class="section-underline"></div>
        </div>
        
        <div class="settings-list collapsible" [class.open]="expandNotifications">
          <div class="setting-item">
            <div class="setting-left">
              <div class="setting-icon">
                <ion-icon name="phone-portrait"></ion-icon>
              </div>
              <div class="setting-title">Smart Vibration</div>
            </div>
            <div class="setting-right">
              <ion-toggle [(ngModel)]="smartVibration" (ionChange)="toggleSmartVibration()"></ion-toggle>
            </div>
          </div>

          <div class="setting-item" (click)="alertSounds()">
            <div class="setting-left">
              <div class="setting-icon">
                <ion-icon name="volume-high"></ion-icon>
              </div>
              <div class="setting-title">Alert Sounds</div>
            </div>
            <div class="setting-right">
              <span class="setting-value">{{selectedAlertSound}}</span>
              <ion-icon name="chevron-forward-outline" class="arrow-icon"></ion-icon>
            </div>
          </div>

          <div class="setting-item">
            <div class="setting-left">
              <div class="setting-icon">
                <ion-icon name="phone-portrait"></ion-icon>
              </div>
              <div class="setting-title">Vibration Pattern</div>
            </div>
            <div class="setting-right">
              <ion-segment [(ngModel)]="selectedVibrationPattern">
                <ion-segment-button value="gentle"><ion-label>Gentle</ion-label></ion-segment-button>
                <ion-segment-button value="default"><ion-label>Default</ion-label></ion-segment-button>
                <ion-segment-button value="strong"><ion-label>Strong</ion-label></ion-segment-button>
              </ion-segment>
            </div>
          </div>
        </div>
      </div>

      <!-- Localization Settings -->
      <div class="form-row">
        <div class="section-header" (click)="toggleSection('localization')">
          <div class="section-title-row">
            <span>Localization</span>
            <ion-icon name="chevron-forward-outline" class="section-toggle-icon" [class.open]="expandLocalization"></ion-icon>
          </div>
          <div class="section-underline"></div>
        </div>
        
        <div class="settings-list collapsible" [class.open]="expandLocalization">
          <div class="setting-item" (click)="languagePreference()">
            <div class="setting-left">
              <div class="setting-icon">
                <ion-icon name="globe"></ion-icon>
              </div>
              <div class="setting-title">Language Preference</div>
            </div>
            <div class="setting-right">
              <span class="setting-value">{{getCurrentLanguageName()}}</span>
              <ion-icon name="chevron-forward-outline" class="arrow-icon"></ion-icon>
            </div>
          </div>

          <div class="setting-item" (click)="unitPreference()">
            <div class="setting-left">
              <div class="setting-icon">
                <ion-icon name="resize"></ion-icon>
              </div>
              <div class="setting-title">Unit System</div>
            </div>
            <div class="setting-right">
              <span class="setting-value">{{selectedUnit}}</span>
              <ion-icon name="chevron-forward-outline" class="arrow-icon"></ion-icon>
            </div>
          </div>
        </div>
      </div>

      <!-- Legal & Support -->
      <div class="form-row">
        <div class="section-header" (click)="toggleSection('legal')">
          <div class="section-title-row">
            <span>Legal & Support</span>
            <ion-icon name="chevron-forward-outline" class="section-toggle-icon" [class.open]="expandLegalSupport"></ion-icon>
          </div>
          <div class="section-underline"></div>
        </div>
        
        <div class="settings-list collapsible" [class.open]="expandLegalSupport">
          <div class="setting-item" (click)="showPrivacyPolicy()">
            <div class="setting-left">
              <div class="setting-icon">
                <ion-icon name="shield"></ion-icon>
              </div>
              <div class="setting-title">Privacy Policy</div>
            </div>
            <div class="setting-right">
              <ion-icon name="chevron-forward-outline" class="arrow-icon"></ion-icon>
            </div>
          </div>

          <div class="setting-item" (click)="showTermsOfService()">
            <div class="setting-left">
              <div class="setting-icon">
                <ion-icon name="document-text"></ion-icon>
              </div>
              <div class="setting-title">Terms of Service</div>
            </div>
            <div class="setting-right">
              <ion-icon name="chevron-forward-outline" class="arrow-icon"></ion-icon>
            </div>
          </div>

          <div class="setting-item" (click)="contactSupport()">
            <div class="setting-left">
              <div class="setting-icon">
                <ion-icon name="help-circle"></ion-icon>
              </div>
              <div class="setting-title">Contact Support</div>
            </div>
            <div class="setting-right">
              <ion-icon name="chevron-forward-outline" class="arrow-icon"></ion-icon>
            </div>
          </div>
        </div>
      </div>
    </form>
  </div>
</ion-content>
