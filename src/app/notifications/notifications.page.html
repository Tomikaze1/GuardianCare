<ion-content class="notifications-content" fullscreen>
  <div class="logo-container">
    <div class="logo-wrapper">
      <div class="custom-logo">
        <ion-icon name="shield" class="shield-icon"></ion-icon>
        <ion-icon name="notifications" class="notifications-icon"></ion-icon>
      </div>
      <div class="logo-glow"></div>
    </div>
    <div class="app-title">Notifications</div>
    <div class="app-subtitle">New incident reports and validations</div>
    <div class="title-underline"></div>
  </div>

    <div class="notification-history-section">

      <!-- Search + Actions -->
      <div class="search-container">
        <div class="search-filter-row">
          <ion-searchbar 
            [(ngModel)]="searchQuery" 
            (ionInput)="onSearchQueryChange()"
            placeholder="Search notifications..."
            show-clear-button="always">
          </ion-searchbar>
          <ion-button fill="clear" class="filter-btn" aria-label="Mark all read" (click)="markAllAsRead()" [disabled]="!notifications.length">
            <ion-icon name="checkmark-done-outline" slot="icon-only"></ion-icon>
          </ion-button>
          <ion-button fill="clear" class="filter-btn" aria-label="Clear all notifications" (click)="clearAllNotifications()" [disabled]="!notifications.length">
            <ion-icon name="trash-outline" slot="icon-only"></ion-icon>
          </ion-button>
          <ion-button id="filtersToggle" fill="clear" class="filter-btn" aria-label="Filters">
            <ion-icon name="options-outline" slot="icon-only"></ion-icon>
          </ion-button>
        </div>

        <!-- Filters Popover -->
        <ion-popover trigger="filtersToggle" triggerAction="click" side="bottom" alignment="end">
          <ng-template>
            <ion-content class="ion-padding">
              <div class="filter-panel">
                <div class="filter-section">
                  <div class="filter-title">STATUS</div>
                  <div class="chip-row">
                    <ion-chip [outline]="statusFilter!=='all'" (click)="onStatusFilterChange('all')"><ion-label>All</ion-label></ion-chip>
                    <ion-chip [outline]="statusFilter!=='unread'" (click)="onStatusFilterChange('unread')"><ion-label>Unread</ion-label></ion-chip>
                    <ion-chip [outline]="statusFilter!=='read'" (click)="onStatusFilterChange('read')"><ion-label>Read</ion-label></ion-chip>
                    <ion-chip [outline]="statusFilter!=='validated'" (click)="onStatusFilterChange('validated')"><ion-label>Validated</ion-label></ion-chip>
                    <ion-chip [outline]="statusFilter!=='zone'" (click)="onStatusFilterChange('zone')"><ion-label>Zone Alerts</ion-label></ion-chip>
                  </div>
                </div>
                <div class="filter-section">
                  <div class="filter-title">RISK LEVEL</div>
                  <div class="chip-row">
                    <ion-chip [outline]="riskFilter!=='all'" (click)="onRiskFilterChange('all')"><ion-label>All</ion-label></ion-chip>
                    <ion-chip [outline]="riskFilter!=='low'" (click)="onRiskFilterChange('low')"><ion-label>Low</ion-label></ion-chip>
                    <ion-chip [outline]="riskFilter!=='moderate'" (click)="onRiskFilterChange('moderate')"><ion-label>Moderate</ion-label></ion-chip>
                    <ion-chip [outline]="riskFilter!=='high'" (click)="onRiskFilterChange('high')"><ion-label>High</ion-label></ion-chip>
                    <ion-chip [outline]="riskFilter!=='critical'" (click)="onRiskFilterChange('critical')"><ion-label>Critical</ion-label></ion-chip>
                  </div>
                </div>
                <div class="filter-section">
                  <div class="filter-title">SORT BY</div>
                  <div class="chip-row">
                    <ion-chip [outline]="sortBy!=='recent'" (click)="onSortByChange('recent')"><ion-label>Recent</ion-label></ion-chip>
                    <ion-chip [outline]="sortBy!=='priority'" (click)="onSortByChange('priority')"><ion-label>Priority</ion-label></ion-chip>
                    <ion-chip [outline]="sortBy!=='type'" (click)="onSortByChange('type')"><ion-label>Type</ion-label></ion-chip>
                  </div>
                </div>
              </div>
            </ion-content>
          </ng-template>
        </ion-popover>
      </div>

      <div class="section-header">
        <div class="section-title-row">
          <span>My Notifications</span>
          <span class="section-count">{{ getUnreadCount() }}/{{ getTotalNotificationCount() }}</span>
        </div>
        <div class="section-underline"></div>
      </div>

      <div class="notifications-list" *ngIf="displayedNotifications.length > 0">
        <div class="notification-group" *ngFor="let group of getGroupedNotifications()">
          <button type="button" class="group-header" (click)="toggleGroup(group.label)">
            <div class="group-left">
              <ion-icon [class.expanded]="isGroupExpanded(group.label)" name="chevron-forward"></ion-icon>
              <span>{{ group.label }}</span>
            </div>
            <span class="group-count">({{ group.notifications.length }})</span>
          </button>

          <ng-container *ngIf="isGroupExpanded(group.label)">
          <ion-item-sliding *ngFor="let notification of group.notifications; trackBy: trackByNotificationId">
            <ion-item-options side="start">
              <ion-item-option color="success" (click)="markAsRead(notification)">
                <ion-icon name="checkmark-outline"></ion-icon>
                <span>Mark Read</span>
              </ion-item-option>
            </ion-item-options>
            
            <ion-item 
              class="notification-card" 
              [class.unread]="!notification.read"
              (click)="handleNotificationClick(notification)">
              
              <div class="notification-header">
                <div class="notification-type">
                  <ion-icon [name]="getNotificationIcon(notification.type)"></ion-icon>
                  <span>{{ getNotificationTypeLabel(notification.type) }}</span>
                  <ion-badge *ngIf="shouldShowNewBadge(notification)" color="success" class="new-badge">NEW</ion-badge>
                </div>
              </div>

              <div class="notification-date">
                <ion-icon name="calendar-outline"></ion-icon>
                <span>{{ formatTimestamp(notification.timestamp) }}</span>
              </div>

              <div class="notification-location" *ngIf="notification.data?.locationAddress">
                <ion-icon name="location-outline"></ion-icon>
                <span>{{ notification.data?.locationAddress }}</span>
              </div>

              <div class="notification-incident" *ngIf="notification.data?.reportType">
                <ion-icon [name]="getIncidentTypeIcon(notification.data.reportType)" class="incident-icon"></ion-icon>
                <span class="incident-label">{{ getIncidentTypeLabel(notification.data.reportType) }}</span>
              </div>

              <div class="notification-risk" *ngIf="notification.data?.adminLevel">
                <div class="level-color-bar" [style.background]="getRiskLevelColor(notification.data.adminLevel)"></div>
                <span class="risk-text">Level {{ notification.data.adminLevel }} - {{ getRiskLevelText(notification.data.adminLevel) }} Risk</span>
              </div>
            </ion-item>
            
            <ion-item-options side="end">
              <ion-item-option color="danger" (click)="deleteNotification(notification)">
                <ion-icon name="trash-outline"></ion-icon>
                <span>Delete</span>
              </ion-item-option>
            </ion-item-options>
          </ion-item-sliding>
          </ng-container>
        </div>

        
      </div>

    <div class="no-notifications" *ngIf="displayedNotifications.length === 0 && !isLoading">
      <ion-icon name="notifications-off-outline"></ion-icon>
      <h3>No Notifications Yet</h3>
      <p>You don't have any notifications yet. New incident reports and validations will appear here.</p>
    </div>

    
  </div>

  <div class="loading-state" *ngIf="isLoading">
    <ion-spinner name="crescent"></ion-spinner>
    <p>Loading notifications...</p>
  </div>
</ion-content>
