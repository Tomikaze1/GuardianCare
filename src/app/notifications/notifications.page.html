<ion-content class="notifications-content" fullscreen>
  <div class="logo-container">
    <div class="logo-wrapper">
      <div class="custom-logo">
        <ion-icon name="shield" class="shield-icon"></ion-icon>
        <ion-icon name="notifications" class="notifications-icon"></ion-icon>
      </div>
      <div class="logo-glow"></div>
    </div>
    <div class="app-title">Notifications</div>
    <div class="app-subtitle">New incident reports and validations</div>
    <div class="title-underline"></div>
  </div>

    <div class="notification-history-section">

      <!-- Search + Actions -->
      <div class="search-container">
        <div class="search-filter-row">
          <ion-searchbar 
            [(ngModel)]="searchQuery" 
            (ionInput)="onSearchQueryChange()"
            (ionClear)="onSearchQueryChange()"
            placeholder="Search notifications..."
            show-clear-button="always">
          </ion-searchbar>
          <ion-button fill="clear" class="filter-btn" aria-label="Mark all read" (click)="markAllAsRead()" [disabled]="!notifications.length">
            <ion-icon name="checkmark-done-outline" slot="icon-only"></ion-icon>
          </ion-button>
          <ion-button fill="clear" class="filter-btn" aria-label="Clear all notifications" (click)="clearAllNotifications()" [disabled]="!notifications.length">
            <ion-icon name="trash-outline" slot="icon-only"></ion-icon>
          </ion-button>
          <ion-button id="filtersToggle" fill="clear" class="filter-btn" aria-label="Filters">
            <ion-icon name="options-outline" slot="icon-only"></ion-icon>
          </ion-button>
        </div>

        <!-- Filters Popover -->
        <ion-popover trigger="filtersToggle" triggerAction="click" side="bottom" alignment="end" cssClass="filters-popover">
          <ng-template>
            <ion-content class="ion-padding" [scrollY]="false">
              <div class="filter-panel">
                <div class="filter-section">
                  <div class="filter-title"><ion-icon name="list-circle-outline"></ion-icon><span>STATUS</span></div>
                  <div class="chip-row">
                    <ion-chip size="small" class="status-all" [outline]="statusFilter!=='all'" (click)="onStatusFilterChange('all')"><ion-label>All</ion-label></ion-chip>
                    <ion-chip size="small" class="status-unread" [outline]="statusFilter!=='unread'" (click)="onStatusFilterChange('unread')"><ion-label>Unread</ion-label></ion-chip>
                    <ion-chip size="small" class="status-read" [outline]="statusFilter!=='read'" (click)="onStatusFilterChange('read')"><ion-label>Read</ion-label></ion-chip>
                    <ion-chip size="small" class="status-validated" [outline]="statusFilter!=='validated'" (click)="onStatusFilterChange('validated')"><ion-label>Validated</ion-label></ion-chip>
                    <ion-chip size="small" class="status-zone" [outline]="statusFilter!=='zone'" (click)="onStatusFilterChange('zone')"><ion-label>Zone Alerts</ion-label></ion-chip>
                  </div>
                </div>
                <div class="filter-section">
                  <div class="filter-title"><ion-icon name="pulse-outline"></ion-icon><span>RISK LEVEL</span></div>
                  <div class="chip-row">
                    <ion-chip size="small" class="risk-all" [outline]="riskFilter!=='all'" (click)="onRiskFilterChange('all')"><ion-label>All</ion-label></ion-chip>
                    <ion-chip size="small" class="risk-low" [outline]="riskFilter!=='low'" (click)="onRiskFilterChange('low')"><ion-label>Low</ion-label></ion-chip>
                    <ion-chip size="small" class="risk-moderate" [outline]="riskFilter!=='moderate'" (click)="onRiskFilterChange('moderate')"><ion-label>Moderate</ion-label></ion-chip>
                    <ion-chip size="small" class="risk-high" [outline]="riskFilter!=='high'" (click)="onRiskFilterChange('high')"><ion-label>High</ion-label></ion-chip>
                    <ion-chip size="small" class="risk-critical" [outline]="riskFilter!=='critical'" (click)="onRiskFilterChange('critical')"><ion-label>Critical</ion-label></ion-chip>
                  </div>
                </div>
                <div class="filter-section">
                  <div class="filter-title"><ion-icon name="funnel-outline"></ion-icon><span>SORT BY</span></div>
                  <div class="chip-row">
                    <ion-chip size="small" class="sort-recent" [outline]="sortBy!=='recent'" (click)="onSortByChange('recent')"><ion-label>Recent</ion-label></ion-chip>
                    <ion-chip size="small" class="sort-priority" [outline]="sortBy!=='priority'" (click)="onSortByChange('priority')"><ion-label>Priority</ion-label></ion-chip>
                    <ion-chip size="small" class="sort-type" [outline]="sortBy!=='type'" (click)="onSortByChange('type')"><ion-label>Type</ion-label></ion-chip>
                  </div>
                </div>
              </div>
            </ion-content>
          </ng-template>
        </ion-popover>
      </div>

      <div class="section-header">
        <div class="section-title-row">
          <span>My Notifications</span>
          <div style="display:flex; align-items:center; gap:8px;">
            <span class="section-count">{{ getUnreadCount() }}/{{ getTotalNotificationCount() }}</span>
            <ion-button id="timeRangeMenu" fill="clear" size="small" aria-label="Time range menu">
              <ion-icon name="ellipsis-horizontal"></ion-icon>
            </ion-button>
          </div>
        </div>
        <div class="section-underline"></div>
      </div>

      <!-- Time range popover -->
      <ion-popover trigger="timeRangeMenu" triggerAction="click" side="bottom" alignment="end" dismissOnSelect="true" cssClass="time-range-popover">
        <ng-template>
          <ion-content class="ion-padding" [scrollY]="false">
            <ion-list lines="none">
              <ion-item button detail="false" (click)="onTimeRangeChange('recent')">
                <ion-icon name="flash-outline" slot="start"></ion-icon>
                <ion-label>Recent</ion-label>
                <ion-icon *ngIf="timeRange==='recent'" name="checkmark-outline" slot="end"></ion-icon>
              </ion-item>
              <ion-item button detail="false" (click)="onTimeRangeChange('week')">
                <ion-icon name="calendar-outline" slot="start"></ion-icon>
                <ion-label>Week</ion-label>
                <ion-icon *ngIf="timeRange==='week'" name="checkmark-outline" slot="end"></ion-icon>
              </ion-item>
              <ion-item button detail="false" (click)="onTimeRangeChange('month')">
                <ion-icon name="calendar-number-outline" slot="start"></ion-icon>
                <ion-label>Month</ion-label>
                <ion-icon *ngIf="timeRange==='month'" name="checkmark-outline" slot="end"></ion-icon>
              </ion-item>
              <ion-item button detail="false" (click)="onTimeRangeChange('old')">
                <ion-icon name="time-outline" slot="start"></ion-icon>
                <ion-label>Old</ion-label>
                <ion-icon *ngIf="timeRange==='old'" name="checkmark-outline" slot="end"></ion-icon>
              </ion-item>
            </ion-list>
          </ion-content>
        </ng-template>
      </ion-popover>

      <div class="notifications-list" *ngIf="displayedNotifications.length > 0">
          <ion-item-sliding *ngFor="let notification of displayedNotifications; trackBy: trackByNotificationId">
            <ion-item-options side="start">
              <ion-item-option color="success" (click)="markAsRead(notification)">
                <ion-icon name="checkmark-outline"></ion-icon>
                <span>Mark Read</span>
              </ion-item-option>
            </ion-item-options>
            
          <ion-item 
            lines="none"
            class="notification-card" 
            [class.unread]="!notification.read"
            (click)="handleNotificationClick(notification)">

              <ion-label class="notification-card-content">
                <div class="notification-header">
                  <div class="notification-type">
                    <ion-icon [name]="getNotificationIcon(notification.type)"></ion-icon>
                    <span>{{ getNotificationTypeLabel(notification.type) }}</span>
                    <ion-badge *ngIf="shouldShowNewBadge(notification)" color="success" class="new-badge">NEW</ion-badge>
                  </div>
                  <div class="notification-timestamp">
                    <ion-icon name="calendar-outline"></ion-icon>
                    <span>{{ formatTimestamp(notification.timestamp) }}</span>
                  </div>
                </div>

                <div class="notification-location" *ngIf="notification.data?.locationAddress">
                  <ion-icon name="location-outline"></ion-icon>
                  <span>{{ notification.data?.locationAddress }}</span>
                </div>

                <div class="notification-meta-row">
                  <div class="notification-incident" *ngIf="notification.data?.reportType">
                    <ion-icon [name]="getIncidentTypeIcon(notification.data.reportType)" class="incident-icon"></ion-icon>
                    <span class="incident-label">{{ getIncidentTypeLabel(notification.data.reportType) }}</span>
                  </div>
                  <div class="notification-risk" *ngIf="notification.data?.adminLevel">
                    <div class="level-color-bar" [style.background]="getRiskLevelColor(notification.data.adminLevel)"></div>
                    <span class="risk-text">Lvl {{ notification.data.adminLevel }} Â· {{ getRiskLevelText(notification.data.adminLevel) }} Risk</span>
                  </div>
                </div>
              </ion-label>
            </ion-item>
            
            <ion-item-options side="end">
              <ion-item-option color="danger" (click)="deleteNotification(notification)">
                <ion-icon name="trash-outline"></ion-icon>
                <span>Delete</span>
              </ion-item-option>
            </ion-item-options>
          </ion-item-sliding>
        
      </div>

    <div class="no-notifications" *ngIf="displayedNotifications.length === 0 && !isLoading">
      <ion-icon name="notifications-off-outline"></ion-icon>
      <h3>{{ getEmptyTitle() }}</h3>
      <p>{{ getEmptySubtitle() }}</p>
    </div>

    
  </div>

  <div class="loading-state" *ngIf="isLoading">
    <ion-spinner name="crescent"></ion-spinner>
    <p>Loading notifications...</p>
  </div>
</ion-content>
