<ion-content class="report-content" fullscreen>
  <div class="logo-container">
    <div class="logo-wrapper">
      <div class="custom-logo">
        <ion-icon name="shield" class="shield-icon"></ion-icon>
        <ion-icon name="location" class="location-pin"></ion-icon>
      </div>
      <div class="logo-glow"></div>
    </div>
    <div class="app-title">{{ 'REPORTS.TITLE' | translate }}</div>
    <div class="app-subtitle">{{ 'REPORTS.SUBTITLE' | translate }}</div>
    <div class="title-underline"></div>
    
    <ion-button 
      expand="block" 
      fill="outline" 
      (click)="toggleHistory()"
      class="history-toggle-btn">
      <ion-icon [name]="showHistory ? 'create-outline' : 'time-outline'" slot="start"></ion-icon>
      {{ showHistory ? 'Create New Report' : 'View My Report History' }}
    </ion-button>
  </div>

  <div class="report-history-section" *ngIf="showHistory">
    <div class="section-header">
      <span>My Report History</span>
      <div class="section-underline"></div>
    </div>

    <div class="history-stats" *ngIf="userReports.length > 0">
      <ion-chip color="primary">
        <ion-icon name="documents-outline"></ion-icon>
        <ion-label>Total: {{ userReports.length }}</ion-label>
      </ion-chip>
      <ion-chip color="warning">
        <ion-icon name="time-outline"></ion-icon>
        <ion-label>Pending: {{ getReportCountByStatus('Pending') }}</ion-label>
      </ion-chip>
      <ion-chip color="success">
        <ion-icon name="checkmark-done-outline"></ion-icon>
        <ion-label>Validated: {{ getReportCountByStatus('Validated') }}</ion-label>
      </ion-chip>
      <ion-chip color="danger">
        <ion-icon name="close-outline"></ion-icon>
        <ion-label>Rejected: {{ getReportCountByStatus('Rejected') }}</ion-label>
      </ion-chip>
    </div>

    <div class="reports-list" *ngIf="userReports.length > 0">
      <div class="report-card" *ngFor="let report of userReports">
        
        <div class="report-header">
          <div class="report-type">
            <ion-icon [name]="getIncidentTypeIcon(report.type)"></ion-icon>
            <span>{{ getIncidentTypeLabel(report.type) }}</span>
          </div>
          <ion-chip [color]="getStatusColor(report.status)" size="small">
            <ion-icon [name]="getStatusIcon(report.status)"></ion-icon>
            <ion-label>{{ report.status }}</ion-label>
          </ion-chip>
        </div>

        <div class="report-date">
          <ion-icon name="calendar-outline"></ion-icon>
          <span>{{ formatReportDate(report.createdAt) }}</span>
        </div>

        <div class="report-location" *ngIf="report.locationAddress">
          <ion-icon name="location-outline"></ion-icon>
          <span>{{ report.locationAddress }}</span>
        </div>

        <div class="report-description">
          <p>{{ report.description }}</p>
        </div>

        <div class="report-media" *ngIf="report.media && report.media.length > 0">
          <div class="media-preview-grid">
            <img 
              *ngFor="let mediaUrl of report.media.slice(0, 3)" 
              [src]="mediaUrl" 
              alt="Report media"
              class="media-thumbnail">
            <div class="media-count" *ngIf="report.media.length > 3">
              +{{ report.media.length - 3 }} more
            </div>
          </div>
        </div>

        <div class="report-validation" *ngIf="report.status === 'Validated'">
          <div class="validation-header">
            <ion-icon name="shield-checkmark-outline"></ion-icon>
            <span>Admin Risk Level</span>
          </div>
          <div class="validation-level-indicator">
            <div class="level-color-bar" [style.background]="getRiskLevelColor(getReportRiskLevel(report))"></div>
            <span class="validation-score">Level {{ getReportRiskLevel(report) }} - {{ getRiskLevelText(getReportRiskLevel(report)) }}</span>
          </div>
          <div class="validation-date" *ngIf="report.validatedAt">
            <small>Validated on {{ formatReportDate(report.validatedAt) }}</small>
          </div>
        </div>

        <div class="report-rejection" *ngIf="report.isRejected">
          <ion-chip color="danger" class="rejection-chip">
            <ion-icon name="alert-circle-outline"></ion-icon>
            <ion-label>Rejected</ion-label>
          </ion-chip>
          <div class="rejection-reason" *ngIf="report.rejectionReason">
            <strong>Reason:</strong> {{ report.rejectionReason }}
          </div>
        </div>

        <ion-button 
          expand="block" 
          fill="clear" 
          size="small"
          (click)="viewReportDetails(report)"
          class="view-details-btn">
          <ion-icon name="information-circle-outline" slot="start"></ion-icon>
          View Full Details
        </ion-button>
      </div>
    </div>

    <div class="no-reports" *ngIf="userReports.length === 0">
      <ion-icon name="document-text-outline"></ion-icon>
      <h3>No Reports Yet</h3>
      <p>You haven't submitted any reports. Create your first report to get started.</p>
    </div>
  </div>

  <form [formGroup]="reportForm" (ngSubmit)="onSubmit()" class="report-form" *ngIf="!showHistory">
    <div class="section-header">
      <span>{{ 'REPORTS.INCIDENT_DETAILS' | translate }}</span>
      <div class="section-underline"></div>
    </div>

    <div class="form-row incident-types">
      <button type="button"
        class="input-box incident-type-btn"
        [class.selected]="selectedIncidentType === 'crime-theft'"
        (click)="selectIncidentType('crime-theft')"
        title="{{ 'REPORTS.TYPE_CRIME' | translate }}">
        <ion-icon name="shield-outline"></ion-icon>
        {{ 'REPORTS.TYPE_CRIME' | translate }}
      </button>
      <button type="button"
        class="input-box incident-type-btn"
        [class.selected]="selectedIncidentType === 'accident'"
        (click)="selectIncidentType('accident')"
        title="{{ 'REPORTS.TYPE_ACCIDENT' | translate }}">
        <ion-icon name="car-outline"></ion-icon>
        {{ 'REPORTS.TYPE_ACCIDENT' | translate }}
      </button>
      <button type="button"
        class="input-box incident-type-btn"
        [class.selected]="selectedIncidentType === 'emergency'"
        (click)="selectIncidentType('emergency')"
        title="{{ 'REPORTS.TYPE_EMERGENCY' | translate }}">
        <ion-icon name="warning-outline"></ion-icon>
        {{ 'REPORTS.TYPE_EMERGENCY' | translate }}
      </button>
      <button type="button"
        class="input-box incident-type-btn"
        [class.selected]="selectedIncidentType === 'suspicious-activity'"
        (click)="selectIncidentType('suspicious-activity')"
        title="{{ 'REPORTS.TYPE_SUSPICIOUS' | translate }}">
        <ion-icon name="eye-outline"></ion-icon>
        {{ 'REPORTS.TYPE_SUSPICIOUS' | translate }}
      </button>
      <button type="button"
        class="input-box incident-type-btn"
        [class.selected]="selectedIncidentType === 'lost-item'"
        (click)="selectIncidentType('lost-item')"
        title="{{ 'REPORTS.TYPE_LOST' | translate }}">
        <ion-icon name="search-outline"></ion-icon>
        {{ 'REPORTS.TYPE_LOST' | translate }}
      </button>
    </div>

    <div class="section-header">
      <span>{{ 'REPORTS.DESCRIPTION' | translate }}</span>
      <div class="section-underline"></div>
    </div>

    <div class="form-row">
      <div class="input-box">
        <ion-icon name="document-text-outline"></ion-icon>
        <textarea
          formControlName="description"
          rows="2"
          maxlength="1000"
          placeholder="{{ 'REPORTS.DESCRIPTION_PH' | translate }}"></textarea>
      </div>
    </div>

    <div class="section-header">
      <span>Incident Time & Date</span>
      <div class="section-underline"></div>
    </div>

    <div class="form-row">
      <div class="input-box time-date-box">
        <div class="time-date-header">
          <ion-icon name="time-outline" class="time-icon"></ion-icon>
          <span class="time-title">When did this happen?</span>
          <button type="button" class="edit-time-btn" (click)="toggleCustomTime()" [class.custom-active]="isCustomTimeEnabled">
            <ion-icon [name]="isCustomTimeEnabled ? 'checkmark-circle' : 'create-outline'" class="edit-icon"></ion-icon>
            <span>{{ isCustomTimeEnabled ? 'Custom Time Set' : 'Edit Time' }}</span>
          </button>
        </div>
        
        <div class="time-date-display">
          <div class="current-time-display" [class.custom-time]="isCustomTimeEnabled">
            <div class="time-main">
              <ion-icon [name]="isCustomTimeEnabled ? 'calendar' : 'time'" class="display-icon"></ion-icon>
              <div class="time-content">
                <div class="time-text">{{ formatTimeOnly(getDisplayDateTime()) }}</div>
                <div class="date-text">{{ formatDateOnly(getDisplayDateTime()) }}</div>
              </div>
            </div>
            
            <div class="time-status">
              <ion-chip [color]="isCustomTimeEnabled ? 'warning' : 'success'" size="small">
                <ion-icon [name]="isCustomTimeEnabled ? 'calendar-outline' : 'checkmark-circle-outline'"></ion-icon>
                <ion-label>{{ isCustomTimeEnabled ? 'Custom Time' : 'Current Time' }}</ion-label>
              </ion-chip>
            </div>
          </div>
          
          <div class="time-actions" *ngIf="isCustomTimeEnabled">
            <ion-button
              fill="clear"
              size="small"
              (click)="openDateTimePicker()"
              class="action-btn edit-btn">
              <ion-icon name="create-outline" slot="start"></ion-icon>
              Change Time
            </ion-button>
            <ion-button
              fill="clear"
              size="small"
              (click)="resetToCurrentTime()"
              class="action-btn reset-btn">
              <ion-icon name="refresh-outline" slot="start"></ion-icon>
              Use Current Time
            </ion-button>
          </div>
        </div>
      </div>
    </div>

    <div class="section-header">
      <span>{{ 'REPORTS.MEDIA_UPLOAD' | translate }}</span>
      <div class="section-underline"></div>
    </div>

    <div class="form-row">
      <div class="input-box media-box">
        <div class="media-buttons">
          <button type="button" (click)="takePhoto()" title="{{ 'REPORTS.TAKE_PHOTO' | translate }}" class="media-btn camera-btn">
            <ion-icon name="camera-outline"></ion-icon>
            <span>{{ 'REPORTS.TAKE_PHOTO' | translate }}</span>
          </button>
          <button type="button" (click)="selectFromGallery()" title="{{ 'REPORTS.GALLERY' | translate }}" class="media-btn gallery-btn">
            <ion-icon name="images-outline"></ion-icon>
            <span>{{ 'REPORTS.GALLERY' | translate }}</span>
          </button>
        </div>
        
        <input type="file" multiple accept="image/*" (change)="onFileSelected($event)" style="display: none;" #fileInput>
        
        <div class="media-list" *ngIf="reportForm.get('media')?.value?.length > 0">
          <div class="media-chip" *ngFor="let media of reportForm.get('media')?.value; let i = index">
            <div class="media-preview" *ngIf="media.webPath || media.dataUrl">
              <img [src]="media.webPath || media.dataUrl" alt="{{ 'REPORTS.MEDIA_PREVIEW' | translate }}" class="preview-image">
            </div>
            <span class="media-name">{{ media.name || 'Photo ' + (i + 1) }}</span>
            <ion-icon name="close" class="remove" (click)="removeFile(i)" title="{{ 'REPORTS.REMOVE' | translate }}"></ion-icon>
          </div>
        </div>
      </div>
    </div>

    <div class="section-header">
      <span>{{ 'REPORTS.LOCATION' | translate }}</span>
      <div class="section-underline"></div>
    </div>

    <div class="form-row">
      <div class="input-box location-box">
        <div class="location-header">
          <ion-icon name="location-outline" class="location-icon"></ion-icon>
          <span class="location-title">{{ 'REPORTS.CURRENT_LOCATION' | translate }}</span>
          <div class="gps-status-indicator" *ngIf="gpsAccuracy">
            <ion-chip [color]="getGPSStatusColor()" size="small">
              <ion-icon name="radio-outline"></ion-icon>
              <ion-label>{{ gpsAccuracy.status }}</ion-label>
            </ion-chip>
          </div>
          <button type="button" class="refresh-location-btn" (click)="refreshLocation()" title="{{ 'REPORTS.REFRESH_LOCATION' | translate }}">
            <ion-icon name="refresh-outline"></ion-icon>
          </button>
        </div>
        
        <div class="map-card" *ngIf="selectedLocation">
          <div class="map-container">
            <div id="reports-map" class="reports-map"></div>
            <div class="map-overlay" *ngIf="isOffline">
              <ion-chip color="warning">
                <ion-icon name="cloud-offline-outline"></ion-icon>
                <ion-label>Offline - Last Known Location</ion-label>
              </ion-chip>
            </div>
          </div>
          
          <div class="address-display" *ngIf="locationAddress">
            <ion-icon name="location-outline" class="address-icon"></ion-icon>
            <div class="address-content">
              <span class="address-label">{{ 'REPORTS.LOCATION_ADDRESS' | translate }}</span>
              <span class="address-text">{{ locationAddress }}</span>
            </div>
          </div>
          
          <div class="location-actions">
            <ion-button
              fill="clear"
              size="small"
              (click)="toggleLocationEditMode()"
              [class.action-btn]="true"
              [class.edit-btn]="!isLocationEditMode"
              [class.current-btn]="isLocationEditMode">
              <ion-icon [name]="isLocationEditMode ? 'checkmark-circle-outline' : 'create-outline'" slot="start"></ion-icon>
              {{ isLocationEditMode ? 'Confirm Location' : 'Edit Location' }}
            </ion-button>
          </div>
        </div>
        
        <div class="location-status" *ngIf="!selectedLocation">
                          <ion-icon name="location-outline" class="status-icon"></ion-icon>
          <span class="status-text">{{ 'REPORTS.LOCATION_UNAVAILABLE' | translate }}</span>
        </div>
      </div>
    </div>

    <div class="section-header">
      <span>Reporter Identity</span>
      <div class="section-underline"></div>
    </div>

    <div class="form-row">
      <div class="input-box time-date-box">
        <div class="time-date-header">
          <ion-icon [name]="reportForm.get('anonymous')?.value ? 'eye-off-outline' : 'person-outline'" class="time-icon"></ion-icon>
          <span class="time-title">Who is reporting this incident?</span>
          <button type="button" class="edit-time-btn" (click)="toggleAnonymous()" [class.custom-active]="reportForm.get('anonymous')?.value">
            <ion-icon [name]="reportForm.get('anonymous')?.value ? 'eye-off' : 'person'" class="edit-icon"></ion-icon>
            <span>{{ reportForm.get('anonymous')?.value ? 'Anonymous' : 'Show Identity' }}</span>
          </button>
        </div>
        
        <div class="time-date-display">
          <div class="current-time-display" [class.custom-time]="reportForm.get('anonymous')?.value">
            <div class="time-main">
              <ion-icon [name]="reportForm.get('anonymous')?.value ? 'shield-outline' : 'person-circle-outline'" class="display-icon"></ion-icon>
              <div class="time-content">
                <div class="time-text">{{ reportForm.get('anonymous')?.value ? 'Anonymous Reporter' : 'Identified Reporter' }}</div>
                <div class="date-text">{{ reportForm.get('anonymous')?.value ? 'Your identity will be kept private' : 'Your name and contact will be included' }}</div>
              </div>
            </div>
            
            <div class="time-status">
              <ion-chip [color]="reportForm.get('anonymous')?.value ? 'warning' : 'success'" size="small">
                <ion-icon [name]="reportForm.get('anonymous')?.value ? 'eye-off-outline' : 'checkmark-circle-outline'"></ion-icon>
                <ion-label>{{ reportForm.get('anonymous')?.value ? 'Anonymous' : 'Public' }}</ion-label>
              </ion-chip>
            </div>
          </div>
          
          <div class="time-actions">
            <ion-button
              fill="clear"
              size="small"
              (click)="setAnonymous(false)"
              class="action-btn"
              [class.current-btn]="!reportForm.get('anonymous')?.value">
              <ion-icon name="person-outline" slot="start"></ion-icon>
              Show My Identity
            </ion-button>
            <ion-button
              fill="clear"
              size="small"
              (click)="setAnonymous(true)"
              class="action-btn"
              [class.edit-btn]="reportForm.get('anonymous')?.value">
              <ion-icon name="eye-off-outline" slot="start"></ion-icon>
              Stay Anonymous
            </ion-button>
          </div>
        </div>
      </div>
    </div>

    <div class="rate-limit-status" *ngIf="rateLimitStatus.remainingReports < 5">
      <ion-chip [color]="rateLimitStatus.isBlocked ? 'danger' : 'warning'">
        <ion-icon name="time-outline"></ion-icon>
        <ion-label>
          {{ rateLimitStatus.remainingReports }} reports remaining this hour
          <span *ngIf="rateLimitStatus.timeUntilReset">(resets in {{ rateLimitStatus.timeUntilReset }})</span>
        </ion-label>
      </ion-chip>
    </div>

    <div class="button-row">
      <button type="submit" class="submit-btn" [disabled]="rateLimitStatus.isBlocked">
        <span>
          <ion-icon name="send-outline"></ion-icon>
          {{ rateLimitStatus.isBlocked ? ( 'REPORTS.RATE_LIMIT_EXCEEDED' | translate ) : ( 'REPORTS.SUBMIT_REPORT' | translate ) }}
        </span>
      </button>
    </div>
  </form>
</ion-content>
