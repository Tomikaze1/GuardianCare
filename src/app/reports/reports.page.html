<ion-header>
  <ion-toolbar>
    <ion-title>
      <ion-icon name="document-text-outline" slot="start"></ion-icon>
      Reports Management
    </ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">
  <!-- Segment Control -->
  <div class="segment-container">
    <ion-segment [(ngModel)]="segment" scrollable>
      <ion-segment-button value="submit" class="segment-button">
        <ion-icon name="add-circle-outline"></ion-icon>
        <ion-label>Submit Report</ion-label>
      </ion-segment-button>
      <ion-segment-button value="history" class="segment-button">
        <ion-icon name="time-outline"></ion-icon>
        <ion-label>Report History</ion-label>
      </ion-segment-button>
    </ion-segment>
  </div>

  <div [ngSwitch]="segment">
    <!-- Submit Report Form -->
    <div *ngSwitchCase="'submit'" class="form-container">
      <div class="form-header">
        <h2>Create New Report</h2>
        <p>Fill in the details below to submit your report</p>
      </div>

      <form #reportForm="ngForm">
        <ion-list class="form-list">
          <!-- Title -->
          <ion-item lines="none" class="form-field">
            <ion-label position="stacked">Report Title <span class="required">*</span></ion-label>
            <ion-input 
              [(ngModel)]="newReport.title" 
              name="title"
              required
              maxlength="100"
              placeholder="Enter a descriptive title"
              counter="true">
            </ion-input>
          </ion-item>

          <!-- Type -->
          <ion-item lines="none" class="form-field">
            <ion-label position="stacked">Report Type <span class="required">*</span></ion-label>
            <ion-select 
              [(ngModel)]="newReport.type" 
              name="type"
              interface="popover"
              required>
              <ion-select-option value="Crime">
                <ion-icon name="warning-outline"></ion-icon>
                Crime
              </ion-select-option>
              <ion-select-option value="Disaster">
                <ion-icon name="alert-circle-outline"></ion-icon>
                Natural Disaster
              </ion-select-option>
              <ion-select-option value="Emergency">
                <ion-icon name="medical-outline"></ion-icon>
                Emergency
              </ion-select-option>
              <ion-select-option value="Infrastructure">
                <ion-icon name="construct-outline"></ion-icon>
                Infrastructure Issue
              </ion-select-option>
              <ion-select-option value="Other">
                <ion-icon name="help-circle-outline"></ion-icon>
                Other
              </ion-select-option>
            </ion-select>
          </ion-item>

          <!-- Priority -->
          <ion-item lines="none" class="form-field">
            <ion-label position="stacked">Priority Level</ion-label>
            <ion-select 
              [(ngModel)]="newReport.priority" 
              name="priority"
              interface="popover">
              <ion-select-option value="Low">
                <span class="priority-low">Low Priority</span>
              </ion-select-option>
              <ion-select-option value="Medium">
                <span class="priority-medium">Medium Priority</span>
              </ion-select-option>
              <ion-select-option value="High">
                <span class="priority-high">High Priority</span>
              </ion-select-option>
              <ion-select-option value="Critical">
                <span class="priority-critical">Critical</span>
              </ion-select-option>
            </ion-select>
          </ion-item>

          <!-- Location -->
          <ion-item lines="none" class="form-field">
            <ion-label position="stacked">Location</ion-label>
            <ion-input 
              [(ngModel)]="newReport.location" 
              name="location"
              placeholder="Enter location or address">
            </ion-input>
            <ion-button 
              slot="end" 
              fill="clear" 
              size="small"
              (click)="getCurrentLocation()">
              <ion-icon name="locate-outline"></ion-icon>
            </ion-button>
          </ion-item>

          <!-- Details -->
          <ion-item lines="none" class="form-field">
            <ion-label position="stacked">Incident Details <span class="required">*</span></ion-label>
            <ion-textarea 
              [(ngModel)]="newReport.details" 
              name="details"
              required
              rows="4"
              maxlength="500"
              placeholder="Describe the incident in detail..."
              counter="true">
            </ion-textarea>
          </ion-item>

          <!-- Contact -->
          <ion-item lines="none" class="form-field">
            <ion-label position="stacked">Contact Number</ion-label>
            <ion-input 
              [(ngModel)]="newReport.contactNumber" 
              name="contactNumber"
              type="tel"
              placeholder="Your contact number">
            </ion-input>
          </ion-item>

          <!-- Media -->
          <div class="media-section">
            <ion-label>Attach Media</ion-label>
            <div class="media-buttons">
              <ion-button fill="outline" size="small" (click)="takePhoto()">
                <ion-icon name="camera" slot="start"></ion-icon>
                Photo
              </ion-button>
              <ion-button fill="outline" size="small" (click)="recordVoice()">
                <ion-icon name="mic" slot="start"></ion-icon>
                Voice
              </ion-button>
            </div>
          </div>

          <!-- Anonymous -->
          <ion-item lines="none" class="anonymous-toggle">
            <ion-checkbox 
              [(ngModel)]="newReport.anonymous" 
              name="anonymous" 
              slot="start">
            </ion-checkbox>
            <ion-label>Submit anonymously</ion-label>
          </ion-item>
        </ion-list>

        <!-- Submit Button -->
        <ion-button 
          expand="block" 
          color="primary" 
          [disabled]="!reportForm.valid || isSubmitting"
          (click)="submitReport()">
          <ion-icon name="send-outline" slot="start"></ion-icon>
          <ion-spinner *ngIf="isSubmitting" name="crescent"></ion-spinner>
          {{ isSubmitting ? 'Submitting...' : 'Submit Report' }}
        </ion-button>
      </form>
    </div>

    <!-- Report History -->
    <div *ngSwitchCase="'history'" class="history-container">
      <div class="history-header">
        <h2>Your Reports</h2>
        <div class="history-controls">
          <ion-searchbar 
            [(ngModel)]="searchTerm" 
            placeholder="Search reports..." 
            animated
            (ionInput)="filterReports($event)">
          </ion-searchbar>
          
          <ion-select 
            [(ngModel)]="filterStatus" 
            placeholder="Filter by status"
            (ionChange)="filterReports()">
            <ion-select-option value="">All Status</ion-select-option>
            <ion-select-option value="Pending">Pending</ion-select-option>
            <ion-select-option value="In Progress">In Progress</ion-select-option>
            <ion-select-option value="Completed">Completed</ion-select-option>
            <ion-select-option value="Rejected">Rejected</ion-select-option>
          </ion-select>
        </div>
      </div>

      <!-- Empty State -->
      <div *ngIf="filteredReports.length === 0" class="empty-state">
        <ion-icon name="document-outline"></ion-icon>
        <h3>No Reports Found</h3>
        <p>{{ reportHistory.length === 0 ? 'You haven\'t submitted any reports yet.' : 'No reports match your current filter.' }}</p>
        <ion-button 
          *ngIf="reportHistory.length === 0"
          fill="outline" 
          (click)="segment = 'submit'">
          Submit Your First Report
        </ion-button>
      </div>

      <!-- Reports List -->
      <ion-list *ngIf="filteredReports.length > 0" class="reports-list">
        <ion-item-sliding *ngFor="let report of filteredReports; trackBy: trackByReportId">
          <ion-item detail="false" class="report-card">
            <div class="report-icon" [style.background]="getReportColor(report.type)">
              <ion-icon [name]="getReportIcon(report.type)"></ion-icon>
            </div>
            
            <ion-label class="report-content">
              <h3>{{ report.title }}</h3>
              <div class="report-meta">
                <ion-badge [color]="getStatusColor(report.status)">{{ report.status }}</ion-badge>
                <span class="report-date">{{ report.timestamp | date:'shortDate' }}</span>
              </div>
              <p class="report-excerpt">{{ report.details | slice:0:100 }}{{ report.details.length > 100 ? '...' : '' }}</p>
            </ion-label>
          </ion-item>

          <ion-item-options side="end">
            <ion-item-option color="primary" (click)="editReport(report)">
              <ion-icon name="create-outline" slot="icon-only"></ion-icon>
            </ion-item-option>
            <ion-item-option color="danger" (click)="deleteReport(report)">
              <ion-icon name="trash-outline" slot="icon-only"></ion-icon>
            </ion-item-option>
          </ion-item-options>
        </ion-item-sliding>
      </ion-list>
    </div>
  </div>
</ion-content>